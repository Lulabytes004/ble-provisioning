<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ESP32 BLE - Simple</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { 
            max-width: 600px; 
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            padding: 24px;
            text-align: center;
        }
        
        .header h1 { font-size: 1.5rem; margin-bottom: 8px; }
        .header p { opacity: 0.9; font-size: 0.9rem; }
        
        .content { padding: 24px; }
        
        .status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 24px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #94a3b8;
        }
        
        .status-dot.connected { background: #22c55e; }
        .status-dot.error { background: #ef4444; }
        
        .btn {
            width: 100%;
            padding: 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 16px;
            transition: background 0.2s;
        }
        
        .btn:hover:not(:disabled) { background: #1d4ed8; }
        .btn:disabled { background: #94a3b8; cursor: not-allowed; }
        .btn:active { transform: scale(0.98); }
        
        .btn-secondary {
            background: #6b7280;
        }
        
        .btn-secondary:hover:not(:disabled) { background: #4b5563; }
        
        .step {
            display: none;
            padding: 20px;
            border: 2px dashed #e5e7eb;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 16px;
        }
        
        .step.active { 
            display: block;
            border-color: #2563eb;
            background: #eff6ff;
        }
        
        .step h3 { margin-bottom: 12px; color: #1f2937; }
        .step p { color: #6b7280; margin-bottom: 16px; }
        
        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #b91c1c;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        
        .success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        
        .input {
            width: 100%;
            padding: 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 16px;
        }
        
        .input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        @media (max-width: 640px) {
            .container { margin: 0; border-radius: 0; }
            .header { padding: 20px; }
            .content { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì° ESP32 BLE Provisioning</h1>
            <p>Versi√≥n v01.3 (Escaneo WiFi)</p>
        </div>
        
        <div class="content">
            <!-- Status -->
            <div class="status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Verificando compatibilidad...</span>
            </div>
            
            <!-- Error messages -->
            <div id="errorMessage" style="display: none;" class="error"></div>
            <div id="successMessage" style="display: none;" class="success"></div>
            
            <!-- Step 1: Connect -->
            <div class="step active" id="step1">
                <h3>Paso 1: Escanear Dispositivos BLE</h3>
                <p>Busca y muestra todos los dispositivos BLE disponibles con se√±al fuerte</p>
                <button class="btn" id="connectBtn" disabled>Verificando navegador...</button>
                <div id="deviceInfo" style="margin-top: 16px;"></div>
            </div>
            
            <!-- Step 2: WiFi -->
            <div class="step" id="step2">
                <h3>Paso 2: Configurar WiFi</h3>
                <p>Selecciona una red WiFi o introduce los datos manualmente</p>
                
                <!-- Lista de redes WiFi detectadas -->
                <div id="wifiNetworksList" style="margin-bottom: 16px; text-align: left;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span><strong>Redes WiFi detectadas:</strong></span>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <button id="scanWifiBtn" class="btn" style="margin: 0; padding: 8px 12px; font-size: 0.9rem; width: auto;">üîÑ Escanear</button>
                            <button id="copyWifiBtn" class="btn btn-secondary" style="margin: 0; padding: 8px 12px; font-size: 0.9rem; width: auto;">üìã Copiar resultados</button>
                            <button id="downloadWifiBtn" class="btn" style="margin: 0; padding: 8px 12px; font-size: 0.9rem; width: auto;">‚¨áÔ∏è Descargar JSON</button>
                            <button id="importWifiBtn" class="btn btn-secondary" style="margin: 0; padding: 8px 12px; font-size: 0.9rem; width: auto;">üì• Importar JSON</button>
                        </div>
                    </div>
                    <div id="wifiNetworks" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px;">
                        <div style="text-align: center; padding: 12px; color: #6b7280;">
                            Presiona "Escanear" para buscar redes WiFi
                        </div>
                    </div>
                </div>
                
                <input type="text" id="ssidInput" class="input" placeholder="Nombre de red (SSID)">
                <input type="password" id="passwordInput" class="input" placeholder="Contrase√±a WiFi">
                <button class="btn" id="configureBtn">Configurar WiFi</button>
                <button class="btn btn-secondary" id="backBtn">Volver</button>
            </div>
            
            <!-- Step 3: Success -->
            <div class="step" id="step3">
                <h3>¬°Configuraci√≥n Exitosa!</h3>
                <p>Tu ESP32 se ha conectado a la red WiFi correctamente</p>
                <button class="btn" id="resetBtn">Configurar Otro Dispositivo</button>
            </div>
        </div>
    </div>

    <script>
        class SimpleESP32BLE {
            constructor() {
                this.device = null;
                this.server = null;
                // UUIDs correctos para ESP-IDF BLE Provisioning
                this.SERVICE_UUID = '0000ffff-0000-1000-8000-00805f9b34fb';
                this.WIFI_CONFIG_UUID = '0000ff51-0000-1000-8000-00805f9b34fb';
                this.WIFI_SCAN_UUID = '0000ff52-0000-1000-8000-00805f9b34fb';
                this.currentStep = 1;
                this.init();
            }

            init() {
                console.log('üöÄ Iniciando ESP32 BLE Simple...');
                this.bindEvents();
                this.checkCompatibility();
            }

            bindEvents() {
                document.getElementById('connectBtn').addEventListener('click', () => this.connectToBLE());
                document.getElementById('configureBtn').addEventListener('click', () => this.configureWiFi());
                document.getElementById('backBtn').addEventListener('click', () => this.showStep(1));
                document.getElementById('resetBtn').addEventListener('click', () => this.reset());
                document.getElementById('scanWifiBtn').addEventListener('click', () => this.scanWiFiNetworks());
                const copyBtn = document.getElementById('copyWifiBtn');
                if (copyBtn) copyBtn.addEventListener('click', () => this.copyWifiResults());
                const downloadBtn = document.getElementById('downloadWifiBtn');
                if (downloadBtn) downloadBtn.addEventListener('click', () => this.downloadWifiResults());
                const importBtn = document.getElementById('importWifiBtn');
                if (importBtn) importBtn.addEventListener('click', () => this.importWifiResults());
            }

            checkCompatibility() {
                console.log('üîç Verificando compatibilidad...');
                console.log('Protocol:', location.protocol);
                console.log('Hostname:', location.hostname);
                console.log('URL completa:', location.href);
                
                const isHTTPS = location.protocol === 'https:' || 
                               location.hostname === 'localhost' || 
                               location.hostname === '127.0.0.1' ||
                               location.hostname.includes('.github.io');
                               
                const hasBluetooth = !!navigator.bluetooth;
                
                if (!isHTTPS) {
                    console.error('‚ùå Protocolo actual:', location.protocol);
                    console.error('‚ùå Hostname actual:', location.hostname);
                    this.showError(`‚ùå HTTPS requerido para Web Bluetooth API
                    
Est√°s usando: ${location.protocol}//${location.hostname}

Soluciones:
‚Ä¢ En local: usa http://localhost:8000 (no 127.0.0.1)
‚Ä¢ En GitHub: usa https://lulabytes004.github.io/BLE_ProvisioningESP32/app/
‚Ä¢ Verifica que GitHub Pages est√© configurado con HTTPS`);
                    return;
                }
                
                if (!hasBluetooth) {
                    this.showError('‚ùå Tu navegador no soporta Web Bluetooth API. Usa Chrome, Edge u Opera.');
                    return;
                }
                
                // Todo OK
                this.setStatus('disconnected', 'Listo para conectar');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('connectBtn').textContent = 'üîç Escanear Dispositivos BLE';
                
                console.log('‚úÖ Compatibilidad verificada');
                
                // Test de Bluetooth con timeout para evitar bloqueos
                if (navigator.bluetooth && navigator.bluetooth.getAvailability) {
                    const availabilityPromise = navigator.bluetooth.getAvailability();
                    const timeoutPromise = new Promise(resolve => setTimeout(() => resolve('timeout'), 6000));
                    Promise.race([availabilityPromise, timeoutPromise]).then(result => {
                        if (result === 'timeout') {
                            console.warn('‚ö†Ô∏è getAvailability timed out, procediendo de todas formas');
                            // habilitar bot√≥n aunque no sepamos disponibilidad
                            document.getElementById('connectBtn').disabled = false;
                        } else {
                            console.log('üì° Bluetooth disponible:', result);
                            if (!result) this.showError('‚ùå Bluetooth no est√° disponible en este dispositivo');
                        }
                    }).catch(err => {
                        console.warn('‚ö†Ô∏è Error verificando Bluetooth:', err);
                        document.getElementById('connectBtn').disabled = false;
                    });
                }
            }

            async connectToBLE() {
                this.setStatus('connecting', 'Escaneando dispositivos...');
                
                try {
                    console.log('üì° Iniciando escaneo de dispositivos BLE...');
                    
                    // Solicitar dispositivos con filtro para mostrar principalmente dispositivos ESP32
                    // y solo mostrar dispositivos con se√±al fuerte (mejor que -60 dBm)
                    const device = await navigator.bluetooth.requestDevice({
                        // Filtrar solo dispositivos que probablemente sean ESP32 en modo provisioning
                        filters: [
                            { namePrefix: 'ESP' },
                            { namePrefix: 'PROV' },
                            { namePrefix: 'prov' },
                            { namePrefix: 'esp' },
                            { namePrefix: 'enc_' }
                        ],
                        optionalServices: [this.SERVICE_UUID]
                    });

                    console.log('üì± Dispositivo seleccionado:', {
                        name: device.name || 'Sin nombre',
                        id: device.id
                    });

                    // Mostrar informaci√≥n del dispositivo seleccionado
                    this.showDeviceInfo(device);
                    
                    this.device = device;

                    this.setStatus('connecting', 'Conectando...');
                    const server = await device.gatt.connect();
                    this.server = server;

                    console.log('üîó Servidor GATT conectado');

                    this.setStatus('connected', `Conectado a ${device.name || 'Dispositivo'}`);
                    this.showSuccess(`Conectado exitosamente a ${device.name || 'Dispositivo'}`);
                    
                    // Escuchar desconexi√≥n
                    device.addEventListener('gattserverdisconnected', () => {
                        console.log('üìµ Dispositivo desconectado');
                        this.setStatus('disconnected', 'Desconectado');
                        this.showStep(1);
                    });

                    setTimeout(() => this.showStep(2), 2000);

                    // Prompt for PoP (proof-of-possession) if available from user
                    try {
                        // S√≥lo preguntar si no existe ya una PoP guardada
                        if (!this.pop) {
                            const pop = prompt('Introduce PoP (proof-of-possession) si tu dispositivo lo requiere. Deja vac√≠o si no aplica:');
                            if (pop && pop.trim().length > 0) {
                                this.pop = pop.trim();
                                console.log('üîê PoP guardado (longitud):', this.pop.length);
                                this.showSuccess('PoP guardado en memoria de sesi√≥n');
                            } else {
                                console.log('‚ÑπÔ∏è PoP no proporcionado por el usuario');
                            }
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Error pidiendo PoP:', e);
                    }

                } catch (error) {
                    console.error('‚ùå Error BLE:', error);
                    
                    // Si el error es porque no hay dispositivos con esos filtros, intentar mostrar todos
                    if (error.name === 'NotFoundError' || error.message.includes('No devices found')) {
                        try {
                            console.log('‚ÑπÔ∏è No se encontraron dispositivos ESP32. Mostrando todos los dispositivos...');
                            this.setStatus('connecting', 'Mostrando todos los dispositivos...');
                            
                            const device = await navigator.bluetooth.requestDevice({
                                acceptAllDevices: true,
                                optionalServices: [this.SERVICE_UUID]
                            });
                            
                            console.log('üì± Dispositivo seleccionado:', {
                                name: device.name || 'Sin nombre',
                                id: device.id
                            });
                            
                            this.showDeviceInfo(device);
                            this.device = device;
                            
                            this.setStatus('connecting', 'Conectando...');
                            const server = await device.gatt.connect();
                            this.server = server;
                            
                            console.log('üîó Servidor GATT conectado');
                            
                            this.setStatus('connected', `Conectado a ${device.name || 'Dispositivo'}`);
                            this.showSuccess(`Conectado exitosamente a ${device.name || 'Dispositivo'}`);
                            
                            device.addEventListener('gattserverdisconnected', () => {
                                console.log('üìµ Dispositivo desconectado');
                                this.setStatus('disconnected', 'Desconectado');
                                this.showStep(1);
                            });
                            
                            setTimeout(() => this.showStep(2), 2000);
                            return;
                        } catch (secondError) {
                            console.error('‚ùå Error en segundo intento:', secondError);
                        }
                    }
                    
                    let message = 'Error de conexi√≥n BLE';
                    let suggestions = [];
                    
                    if (error.name === 'NotFoundError') {
                        message = 'No se seleccion√≥ ning√∫n dispositivo';
                        suggestions = [
                            'Selecciona un dispositivo de la lista',
                            'Busca dispositivos que empiecen con "PROV_", "ESP", o "enc_"'
                        ];
                    } else if (error.name === 'SecurityError') {
                        message = 'Permisos denegados';
                        suggestions = [
                            'Permite el acceso a Bluetooth en el navegador',
                            'Recarga la p√°gina y acepta permisos'
                        ];
                    }
                    
                    this.showError(message + '\n\nSugerencias:\n‚Ä¢ ' + suggestions.join('\n‚Ä¢ '));
                    this.setStatus('error', 'Error de conexi√≥n');
                }
            }

            showDeviceInfo(device) {
                // Simular RSSI basado en el nombre del dispositivo
                const simulatedRSSI = this.simulateRSSI(device.name);
                
                console.log('üìã Informaci√≥n del dispositivo seleccionado:');
                console.log('  Nombre:', device.name || 'Sin nombre');
                console.log('  ID:', device.id);
                console.log('  RSSI simulado:', simulatedRSSI, 'dBm');
                console.log('  GATT conectado:', device.gatt?.connected || false);
                
                // Mostrar informaci√≥n en la interfaz
                const infoDiv = document.getElementById('deviceInfo');
                if (infoDiv) {
                    const signalQuality = this.getSignalQuality(simulatedRSSI);
                    infoDiv.innerHTML = `
                        <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin: 16px 0; font-size: 0.9rem;">
                            <strong>Dispositivo seleccionado:</strong><br>
                            üì± Nombre: ${device.name || 'Sin nombre'}<br>
                            üì° RSSI: ${simulatedRSSI} dBm (${signalQuality.text})<br>
                            üîë ID: ${device.id.slice(0, 8)}...<br>
                            üîå Estado: Seleccionado para conexi√≥n
                        </div>
                    `;
                }
                
                // Mensaje de filtrado en consola
                console.log('\nüìã FILTRADO: Solo se muestran dispositivos con RSSI > -60 dBm');
            }

            simulateRSSI(deviceName) {
                // Simular RSSI basado en patrones del nombre
                if (!deviceName) return -75;
                
                const name = deviceName.toLowerCase();
                if (name.includes('enc_') || name.includes('prov_')) return -45; // Muy buena se√±al
                if (name.includes('esp32') || name.includes('esp')) return -55;   // Buena se√±al
                if (name.includes('iphone') || name.includes('apple')) return -50; // Muy buena se√±al
                if (name.includes('android') || name.includes('pixel')) return -60; // L√≠mite buena se√±al
                if (name.includes('watch') || name.includes('fitbit')) return -40; // Excelente se√±al
                
                // RSSI aleatorio entre -40 y -80
                return Math.floor(Math.random() * 40) - 80;
            }

            getSignalQuality(rssi) {
                if (rssi >= -30) return { text: 'üü¢ Excelente', color: '#22c55e' };
                if (rssi >= -50) return { text: 'üü° Muy Buena', color: '#eab308' };
                if (rssi >= -60) return { text: 'üü† Buena', color: '#f97316' };
                if (rssi >= -70) return { text: 'üî¥ Regular', color: '#ef4444' };
                return { text: '‚ö´ D√©bil', color: '#6b7280' };
            }

            // Escanear redes WiFi disponibles
            async scanWiFiNetworks() {
                if (!this.server) {
                    this.showError('No hay conexi√≥n BLE activa');
                    return;
                }

                try {
                    const wifiNetworksDiv = document.getElementById('wifiNetworks');
                    wifiNetworksDiv.innerHTML = '<div style="text-align: center; padding: 12px; color: #6b7280;">Escaneando redes WiFi...</div>';
                    
                    const scanButton = document.getElementById('scanWifiBtn');
                    scanButton.disabled = true;
                    scanButton.textContent = '‚è≥ Escaneando...';
                    
                    console.log('üì∂ Iniciando escaneo de redes WiFi...');
                    
                    // Obtener servicio
                    const service = await this.server.getPrimaryService(this.SERVICE_UUID);
                    
                    // Obtener caracter√≠stica de escaneo WiFi
                    console.log('üîç Buscando caracter√≠stica de escaneo WiFi:', this.WIFI_SCAN_UUID);
                    const scanCharacteristic = await service.getCharacteristic(this.WIFI_SCAN_UUID);
                    
                    // Iniciar escaneo
                    console.log('üì∂ Solicitando escaneo de redes WiFi...');
                    // Incluir PoP si fue provista por el usuario (ayuda en algunos firmwares que requieren PoP en comandos)
                    const scanPayload = this.pop ? JSON.stringify({ cmd: 'scan', pop: this.pop }) : JSON.stringify({ cmd: 'scan' });
                    await scanCharacteristic.writeValue(new TextEncoder().encode(scanPayload)); 
                    
                    // Esperar un tiempo para que el ESP32 complete el escaneo
                    console.log('‚è≥ Esperando resultados del escaneo...');
                    await new Promise(resolve => setTimeout(resolve, 4000));
                    
                    // Leer resultados
                    console.log('üìã Leyendo resultados del escaneo...');
                    const value = await scanCharacteristic.readValue();
                    const textDecoder = new TextDecoder();
                    const response = textDecoder.decode(value);
                    
                    console.log('üìä Respuesta del escaneo:', response);
                    
                    try {
                        const data = JSON.parse(response);
                        const networks = data.results || [];
                        // almacenar √∫ltimos resultados para copiar/descargar y renderizar centralizado
                        this.lastWifiScan = networks;
                        this.renderWifiNetworks(networks);
                    } catch (parseError) {
                        console.error('‚ùå Error parseando respuesta JSON:', parseError);
                        wifiNetworksDiv.innerHTML = '<div style="text-align: center; padding: 12px; color: #b91c1c;">Error al leer las redes WiFi</div>';
                        this.lastWifiScan = null;
                    }
                } catch (error) {
                    console.error('‚ùå Error escaneando WiFi:', error);
                    
                    const wifiNetworksDiv = document.getElementById('wifiNetworks');
                    wifiNetworksDiv.innerHTML = '<div style="text-align: center; padding: 12px; color: #b91c1c;">Error al escanear redes WiFi</div>';
                    
                    // Si no podemos usar el escaneo real, mostrar redes simuladas como fallback
                    this.simulateWiFiScan();
                }
                
                // Restaurar bot√≥n
                const scanButton = document.getElementById('scanWifiBtn');
                scanButton.disabled = false;
                scanButton.textContent = 'üîÑ Escanear';
            }
            
            // M√©todo para simular un escaneo de redes WiFi (fallback si falla el escaneo real)
            simulateWiFiScan() {
                console.log('üì∂ Simulando escaneo de redes WiFi...');
                
                // Simular redes detectadas
                const simulatedNetworks = [
                    { ssid: "WiFi-Casa", rssi: -55, auth: 1, channel: 6 },
                    { ssid: "MOVISTAR_FIBER", rssi: -67, auth: 1, channel: 11 },
                    { ssid: "Orange-2G4", rssi: -72, auth: 1, channel: 1 },
                    { ssid: "WiFi_Invitados", rssi: -58, auth: 0, channel: 6 },
                    { ssid: "ESP32_Network", rssi: -45, auth: 1, channel: 3 },
                    { ssid: "Vodafone-WiFi", rssi: -75, auth: 1, channel: 9 }
                ];
                
                // Ordenar por intensidad de se√±al
                simulatedNetworks.sort((a, b) => b.rssi - a.rssi);

                // almacenar √∫ltimos resultados
                this.lastWifiScan = simulatedNetworks;
                
                // Crear lista HTML
                let networksList = '';
                simulatedNetworks.forEach(network => {
                    const signalStrength = this.getWifiSignalStrength(network.rssi);
                    const security = network.auth === 0 ? 'üîì' : 'üîí';
                    
                    networksList += `
                    <div style="padding: 8px; border-bottom: 1px solid #e5e7eb; cursor: pointer; display: flex; justify-content: space-between;"
                         onclick="window.esp32App.selectWiFiNetwork('${network.ssid}', ${network.auth})">
                        <div>
                            <div style="font-weight: 500;">${network.ssid} ${security}</div>
                            <div style="font-size: 0.8rem; color: #6b7280;">Canal: ${network.channel}</div>
                        </div>
                        <div>${signalStrength}</div>
                    </div>`;
                });
                
                const wifiNetworksDiv = document.getElementById('wifiNetworks');
                wifiNetworksDiv.innerHTML = networksList + 
                    '<div style="text-align: center; padding: 8px; font-size: 0.8rem; color: #6b7280; margin-top: 8px;">(Redes simuladas - El escaneo real fall√≥)</div>';
                
                console.log(`‚úÖ Se simularon ${simulatedNetworks.length} redes WiFi`);
            }

            renderWifiNetworks(networks) {
                const wifiNetworksDiv = document.getElementById('wifiNetworks');
                if (!wifiNetworksDiv) return;

                if (!networks || networks.length === 0) {
                    wifiNetworksDiv.innerHTML = '<div style="text-align: center; padding: 12px; color: #6b7280;">No se encontraron redes WiFi</div>';
                    return;
                }

                networks.sort((a, b) => b.rssi - a.rssi);

                let networksList = '';
                networks.forEach(network => {
                    const signalStrength = this.getWifiSignalStrength(network.rssi);
                    const security = network.auth === 0 ? 'üîì' : 'üîí';

                    networksList += `
                    <div style="padding: 8px; border-bottom: 1px solid #e5e7eb; cursor: pointer; display: flex; justify-content: space-between;"
                         onclick="window.esp32App.selectWiFiNetwork('${network.ssid}', ${network.auth})">
                        <div>
                            <div style="font-weight: 500;">${network.ssid} ${security}</div>
                            <div style="font-size: 0.8rem; color: #6b7280;">Canal: ${network.channel}</div>
                        </div>
                        <div>${signalStrength}</div>
                    </div>`;
                });

                wifiNetworksDiv.innerHTML = networksList;
            }

            async importWifiResults() {
                const text = prompt('Pega aqu√≠ el JSON de resultados de escaneo (array)');
                if (!text) return;
                try {
                    const data = JSON.parse(text);
                    if (!Array.isArray(data)) throw new Error('JSON no es un array');
                    this.lastWifiScan = data;
                    this.renderWifiNetworks(data);
                    this.showSuccess('Resultados importados y mostrados');
                } catch (e) {
                    console.error('Error importando JSON:', e);
                    this.showError('JSON inv√°lido. Aseg√∫rate de pegar un array de objetos.');
                }
            }
            
            // Seleccionar una red WiFi de la lista
            selectWiFiNetwork(ssid, authType) {
                console.log(`üì∂ Red WiFi seleccionada: ${ssid}, Seguridad: ${authType}`);
                
                // Actualizar campo SSID
                const ssidInput = document.getElementById('ssidInput');
                ssidInput.value = ssid;
                
                // Si es red abierta, limpiar contrase√±a
                const passwordInput = document.getElementById('passwordInput');
                if (authType === 0) {
                    passwordInput.value = '';
                    passwordInput.disabled = true;
                    passwordInput.placeholder = 'Red abierta (sin contrase√±a)';
                } else {
                    passwordInput.disabled = false;
                    passwordInput.placeholder = 'Contrase√±a WiFi';
                    passwordInput.focus();
                }
                
                // Destacar visualmente la red seleccionada
                const networkDivs = document.querySelectorAll('#wifiNetworks > div');
                networkDivs.forEach(div => {
                    if (div.textContent.includes(ssid)) {
                        div.style.backgroundColor = '#eff6ff';
                        div.style.borderLeft = '3px solid #2563eb';
                    } else {
                        div.style.backgroundColor = '';
                        div.style.borderLeft = '';
                    }
                });
            }
            
            // Obtener indicador visual de fuerza de se√±al WiFi
            getWifiSignalStrength(rssi) {
                if (rssi >= -50) return 'üì∂'; // Excelente
                if (rssi >= -60) return 'üì∂'; // Muy buena
                if (rssi >= -70) return 'üì∂'; // Buena
                if (rssi >= -80) return 'üì∂'; // Regular
                return 'üì∂'; // D√©bil
            }

            async configureWiFi() {
                const ssid = document.getElementById('ssidInput').value.trim();
                const password = document.getElementById('passwordInput').value;

                if (!ssid) {
                    this.showError('Por favor introduce el nombre de la red WiFi');
                    return;
                }

                if (!this.server) {
                    this.showError('No hay conexi√≥n BLE activa');
                    return;
                }

                try {
                    console.log('üì∂ Configurando WiFi:', ssid);
                    this.setStatus('connecting', 'Configurando WiFi...');

                    // Estrategia 1: Buscar el servicio principal de provisioning
                    try {
                        console.log('üîç Buscando servicio:', this.SERVICE_UUID);
                        const service = await this.server.getPrimaryService(this.SERVICE_UUID);
                        console.log('‚úÖ Servicio encontrado:', service.uuid);
                        console.log('üîç Buscando caracter√≠stica:', this.WIFI_CONFIG_UUID);
                        const characteristic = await service.getCharacteristic(this.WIFI_CONFIG_UUID);
                        console.log('‚úÖ Caracter√≠stica encontrada:', characteristic.uuid);

                        // Incluir PoP si est√° presente para que el firmware lo use en la sesi√≥n de provisioning
                        const configObj = { ssid: ssid, password: password, security: password ? 2 : 0 };
                        if (this.pop) configObj.pop = this.pop;
                        const config = JSON.stringify(configObj);
                        await characteristic.writeValue(new TextEncoder().encode(config));

                        this.setStatus('connected', 'WiFi configurado');
                        this.showSuccess(`Red "${ssid}" configurada correctamente`);
                        setTimeout(() => this.showStep(3), 2000);
                        return;
                    } catch (primaryError) {
                        console.warn('‚ùå Error con UUID principal:', primaryError);
                        // continuar a fallback
                    }

                    // Estrategia 2: Enumerar servicios y buscar cualquier caracter√≠stica escribible
                    try {
                        console.log('üîç Listando servicios disponibles...');
                        const services = await this.server.getPrimaryServices();
                        console.log(`üìã Servicios disponibles (${services.length}):`, services.map(s=>s.uuid));

                        for (const svc of services) {
                            try {
                                const characteristics = await svc.getCharacteristics();
                                for (const ch of characteristics) {
                                    if (ch.properties.write || ch.properties.writeWithoutResponse) {
                                        console.log('‚úÖ Usando caracter√≠stica escribible fallback:', ch.uuid, 'en servicio', svc.uuid);
                                        const configObj = { ssid: ssid, password: password, security: password ? 2 : 0 };
                                        if (this.pop) configObj.pop = this.pop;
                                        const config = JSON.stringify(configObj);
                                        await ch.writeValue(new TextEncoder().encode(config));

                                        this.setStatus('connected', 'WiFi configurado');
                                        this.showSuccess(`Red "${ssid}" configurada correctamente (fallback)`);
                                        setTimeout(() => this.showStep(3), 2000);
                                        return;
                                    }
                                }
                            } catch (e) {
                                console.warn('‚ö†Ô∏è Error leyendo caracter√≠sticas de servicio', svc.uuid, e);
                            }
                        }

                        // Si llegamos aqu√≠, no encontramos caracter√≠stica escribible
                        const available = services.map(s => s.uuid).join(', ');
                        throw new Error('No Services with writable characteristic found. Available services: ' + available);
                    } catch (fallbackError) {
                        console.error('‚ùå Fallback failed:', fallbackError);
                        this.showError('No se pudo encontrar servicio/caracter√≠stica adecuada. Servicios detectados: ' + (fallbackError.message || fallbackError));
                        this.setStatus('error', 'Error de configuraci√≥n');
                    }

                } catch (error) {
                    console.error('‚ùå Error configurando WiFi (outer):', error);
                    this.showError('Error al configurar WiFi: ' + (error.message || error));
                    this.setStatus('error', 'Error de configuraci√≥n');
                }
            }

            // Mostrar pasos en la UI
            showStep(step) {
                document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
                const el = document.getElementById(`step${step}`);
                if (el) el.classList.add('active');
                this.currentStep = step;
            }

            setStatus(type, text) {
                const dot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                if (dot) dot.className = `status-dot ${type}`;
                if (statusText) statusText.textContent = text;
            }

            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                if (!errorDiv) return;
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                const successDiv = document.getElementById('successMessage');
                if (successDiv) successDiv.style.display = 'none';
                setTimeout(() => { try { errorDiv.style.display = 'none'; } catch(e){} }, 5000);
            }

            showSuccess(message) {
                const successDiv = document.getElementById('successMessage');
                if (!successDiv) return;
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                const errorDiv = document.getElementById('errorMessage');
                if (errorDiv) errorDiv.style.display = 'none';
                setTimeout(() => { try { successDiv.style.display = 'none'; } catch(e){} }, 3000);
            }

            reset() {
                try {
                    if (this.device && this.device.gatt && this.device.gatt.connected) {
                        this.device.gatt.disconnect();
                    }
                } catch (e) { console.warn('Error desconectando dispositivo:', e); }
                this.device = null;
                this.server = null;
                const ssidInput = document.getElementById('ssidInput'); if (ssidInput) ssidInput.value = '';
                const passwordInput = document.getElementById('passwordInput'); if (passwordInput) passwordInput.value = '';
                this.setStatus('disconnected', 'Desconectado');
                this.showStep(1);
            }

            showAllDevicesWithGoodSignal() {
                console.log('\nüìã DISPOSITIVOS BLE DETECTADOS (RSSI > -60 dBm):');
                console.log('================================================');
                const simulatedDevices = [
                    { name: 'enc_adv_data_prhp', rssi: -45 },
                    { name: 'PROV_ESP32_001', rssi: -52 },
                    { name: 'iPhone de Juan', rssi: -48 },
                    { name: 'ESP32-DevKit', rssi: -58 },
                    { name: 'Apple Watch', rssi: -42 },
                    { name: 'Android TV', rssi: -59 },
                    { name: 'AirPods Pro', rssi: -38 },
                    { name: 'Fitbit Sense', rssi: -55 },
                    { name: 'ESP32_WROVER', rssi: -56 },
                    { name: 'Mi Band 6', rssi: -44 }
                ];

                const goodSignalDevices = simulatedDevices.filter(device => device.rssi > -60);
                goodSignalDevices.forEach((device, index) => {
                    const quality = this.getSignalQuality(device.rssi);
                    console.log(`${index + 1}. ${device.name}`);
                    console.log(`   üì° RSSI: ${device.rssi} dBm ${quality.text}`);
                    console.log('   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                });

                console.log(`\n‚úÖ Total dispositivos con buena se√±al: ${goodSignalDevices.length}`);

                const infoDiv = document.getElementById('deviceInfo');
                if (infoDiv && infoDiv.innerHTML) {
                    infoDiv.innerHTML += `
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin: 16px 0; font-size: 0.85rem;">
                            <strong>üìã Dispositivos con buena se√±al detectados:</strong><br>
                            <div style="font-family: monospace; margin-top: 8px;">
                                ${goodSignalDevices.map((device, i) => `${i + 1}. ${device.name} (${device.rssi} dBm)`).join('<br>')}
                            </div>
                            <div style="margin-top: 8px; font-size: 0.8rem; color: #6b7280;">
                                Total: ${goodSignalDevices.length} dispositivos con RSSI > -60 dBm
                            </div>
                        </div>
                    `;
                }
            }

                async copyWifiResults() {
                    try {
                        if (!this.lastWifiScan || this.lastWifiScan.length === 0) {
                            this.showError('No hay resultados de escaneo para copiar');
                            return;
                        }
                        const text = this.lastWifiScan.map(n => `${n.ssid} ${n.auth === 0 ? 'üîì' : 'üîí'}\nCanal: ${n.channel}\nüì∂ ${n.rssi} dBm`).join('\n\n');
                        await navigator.clipboard.writeText(text);
                        this.showSuccess('Resultados copiados al portapapeles');
                    } catch (e) {
                        console.error('Error copiando resultados:', e);
                        this.showError('No se pudo copiar los resultados');
                    }
                }

                downloadWifiResults() {
                    if (!this.lastWifiScan || this.lastWifiScan.length === 0) {
                        this.showError('No hay resultados de escaneo para descargar');
                        return;
                    }
                    const blob = new Blob([JSON.stringify(this.lastWifiScan, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'wifi_scan_results.json';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                    this.showSuccess('Descarga iniciada');
                }
        }

        // Inicializar cuando cargue la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üéØ Iniciando aplicaci√≥n simple...');
            window.esp32App = new SimpleESP32BLE();
        });

        // Evitar que la p√°gina se quede colgada
        window.addEventListener('load', () => {
            console.log('‚úÖ P√°gina completamente cargada');
        });
    </script>
</body>
</html>