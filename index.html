<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ESP32 BLE - Simple</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { 
            max-width: 600px; 
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            padding: 24px;
            text-align: center;
        }
        
        .header h1 { font-size: 1.5rem; margin-bottom: 8px; }
        .header p { opacity: 0.9; font-size: 0.9rem; }
        
        .content { padding: 24px; }
        
        .status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 24px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #94a3b8;
        }
        
        .status-dot.connected { background: #22c55e; }
        .status-dot.error { background: #ef4444; }
        
        .btn {
            width: 100%;
            padding: 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 16px;
            transition: background 0.2s;
        }
        
        .btn:hover:not(:disabled) { background: #1d4ed8; }
        .btn:disabled { background: #94a3b8; cursor: not-allowed; }
        .btn:active { transform: scale(0.98); }
        
        .btn-secondary {
            background: #6b7280;
        }
        
        .btn-secondary:hover:not(:disabled) { background: #4b5563; }
        
        .step {
            display: none;
            padding: 20px;
            border: 2px dashed #e5e7eb;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 16px;
        }
        
        .step.active { 
            display: block;
            border-color: #2563eb;
            background: #eff6ff;
        }
        
        .step h3 { margin-bottom: 12px; color: #1f2937; }
        .step p { color: #6b7280; margin-bottom: 16px; }
        
        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #b91c1c;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        
        .success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        
        .input {
            width: 100%;
            padding: 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 16px;
        }
        
        .input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        @media (max-width: 640px) {
            .container { margin: 0; border-radius: 0; }
            .header { padding: 20px; }
            .content { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì° ESP32 BLE Provisioning</h1>
            <p>Versi√≥n v01.02 (UUIDs corregidos)</p>
        </div>
        
        <div class="content">
            <!-- Status -->
            <div class="status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Verificando compatibilidad...</span>
            </div>
            
            <!-- Error messages -->
            <div id="errorMessage" style="display: none;" class="error"></div>
            <div id="successMessage" style="display: none;" class="success"></div>
            
            <!-- Step 1: Connect -->
            <div class="step active" id="step1">
                <h3>Paso 1: Escanear Dispositivos BLE</h3>
                <p>Busca y muestra todos los dispositivos BLE disponibles con se√±al fuerte</p>
                <button class="btn" id="connectBtn" disabled>Verificando navegador...</button>
                <div id="deviceInfo" style="margin-top: 16px;"></div>
            </div>
            
            <!-- Step 2: WiFi -->
            <div class="step" id="step2">
                <h3>Paso 2: Configurar WiFi</h3>
                <p>Introduce los datos de tu red WiFi</p>
                <input type="text" id="ssidInput" class="input" placeholder="Nombre de red (SSID)">
                <input type="password" id="passwordInput" class="input" placeholder="Contrase√±a WiFi">
                <button class="btn" id="configureBtn">Configurar WiFi</button>
                <button class="btn btn-secondary" id="backBtn">Volver</button>
            </div>
            
            <!-- Step 3: Success -->
            <div class="step" id="step3">
                <h3>¬°Configuraci√≥n Exitosa!</h3>
                <p>Tu ESP32 se ha conectado a la red WiFi correctamente</p>
                <button class="btn" id="resetBtn">Configurar Otro Dispositivo</button>
            </div>
        </div>
    </div>

    <script>
        class SimpleESP32BLE {
            constructor() {
                this.device = null;
                this.server = null;
                
                // UUIDs correctos del ESP32 Provisioning
                this.SERVICE_UUID = '0000ffff-0000-1000-8000-00805f9b34fb';
                this.WIFI_CONFIG_UUID = '0000ff51-0000-1000-8000-00805f9b34fb';
                this.WIFI_CONTROL_UUID = '0000ff52-0000-1000-8000-00805f9b34fb';
                this.PROTO_VER_UUID = '0000ff53-0000-1000-8000-00805f9b34fb';
                
                // UUIDs alternativos (versiones cortas y otras implementaciones)
                this.SERVICE_UUID_ALT = ['FFFF', 'ABCD1234-5678-9012-3456-7890ABCDEF12'];
                this.WIFI_CONFIG_UUID_ALT = ['FF51'];
                
                this.currentStep = 1;
                this.init();
            }

            init() {
                console.log('üöÄ Iniciando ESP32 BLE Simple...');
                this.bindEvents();
                this.checkCompatibility();
            }

            bindEvents() {
                document.getElementById('connectBtn').addEventListener('click', () => this.connectToBLE());
                document.getElementById('configureBtn').addEventListener('click', () => this.configureWiFi());
                document.getElementById('backBtn').addEventListener('click', () => this.showStep(1));
                document.getElementById('resetBtn').addEventListener('click', () => this.reset());
            }

            checkCompatibility() {
                console.log('üîç Verificando compatibilidad...');
                console.log('Protocol:', location.protocol);
                console.log('Hostname:', location.hostname);
                console.log('URL completa:', location.href);
                
                const isHTTPS = location.protocol === 'https:' || 
                               location.hostname === 'localhost' || 
                               location.hostname === '127.0.0.1' ||
                               location.hostname.includes('.github.io');
                               
                const hasBluetooth = !!navigator.bluetooth;
                
                if (!isHTTPS) {
                    console.error('‚ùå Protocolo actual:', location.protocol);
                    console.error('‚ùå Hostname actual:', location.hostname);
                    this.showError(`‚ùå HTTPS requerido para Web Bluetooth API
                    
Est√°s usando: ${location.protocol}//${location.hostname}

Soluciones:
‚Ä¢ En local: usa http://localhost:8000 (no 127.0.0.1)
‚Ä¢ En GitHub: usa https://lulabytes004.github.io/BLE_ProvisioningESP32/app/
‚Ä¢ Verifica que GitHub Pages est√© configurado con HTTPS`);
                    return;
                }
                
                if (!hasBluetooth) {
                    this.showError('‚ùå Tu navegador no soporta Web Bluetooth API. Usa Chrome, Edge u Opera.');
                    return;
                }
                
                // Todo OK
                this.setStatus('disconnected', 'Listo para conectar');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('connectBtn').textContent = 'üîç Escanear Dispositivos BLE';
                
                console.log('‚úÖ Compatibilidad verificada');
                
                // Test de Bluetooth
                if (navigator.bluetooth.getAvailability) {
                    navigator.bluetooth.getAvailability().then(available => {
                        console.log('üì° Bluetooth disponible:', available);
                        if (!available) {
                            this.showError('‚ùå Bluetooth no est√° disponible en este dispositivo');
                        }
                    }).catch(err => {
                        console.warn('‚ö†Ô∏è Error verificando Bluetooth:', err);
                    });
                }
            }

            async connectToBLE() {
                this.setStatus('connecting', 'Escaneando todos los dispositivos...');
                
                try {
                    console.log('üì° Iniciando escaneo de dispositivos BLE...');
                    
                    // Incluir todos los UUIDs de servicios posibles para mayor compatibilidad
                    const optionalServices = [
                        this.SERVICE_UUID,
                        ...this.SERVICE_UUID_ALT
                    ];
                    
                    console.log('üîç Buscando dispositivos con servicios:', optionalServices);
                    
                    // Solicitar todos los dispositivos para mostrar lista completa
                    const device = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices: optionalServices
                    });

                    // Simular obtenci√≥n de RSSI (Web Bluetooth no expone RSSI directamente)
                    // En una implementaci√≥n real, necesitar√≠as usar navigator.bluetooth.requestLEScan
                    console.log('üì± Dispositivo seleccionado:', {
                        name: device.name || 'Sin nombre',
                        id: device.id
                    });

                    // Mostrar informaci√≥n del dispositivo seleccionado
                    this.showDeviceInfo(device);
                    
                    this.device = device;

                    this.setStatus('connecting', 'Conectando...');
                    const server = await device.gatt.connect();
                    this.server = server;

                    console.log('üîó Servidor GATT conectado');

                    // Intentar listar todos los servicios disponibles para debug
                    try {
                        const services = await server.getPrimaryServices();
                        console.log(`üìã Servicios disponibles (${services.length}):`);
                        for (const service of services) {
                            console.log(`- Servicio: ${service.uuid}`);
                            try {
                                const characteristics = await service.getCharacteristics();
                                console.log(`  Caracter√≠sticas (${characteristics.length}):`);
                                for (const char of characteristics) {
                                    console.log(`  - ${char.uuid}`);
                                }
                            } catch (e) {
                                console.log(`  Error al obtener caracter√≠sticas: ${e}`);
                            }
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è No se pudieron listar todos los servicios:', e);
                    }

                    this.setStatus('connected', `Conectado a ${device.name || 'Dispositivo'}`);
                    this.showSuccess(`Conectado exitosamente a ${device.name || 'Dispositivo'}`);
                    
                    // Escuchar desconexi√≥n
                    device.addEventListener('gattserverdisconnected', () => {
                        console.log('üìµ Dispositivo desconectado');
                        this.setStatus('disconnected', 'Desconectado');
                        this.showStep(1);
                    });

                    setTimeout(() => this.showStep(2), 2000);

                } catch (error) {
                    console.error('‚ùå Error BLE:', error);
                    
                    let message = 'Error de conexi√≥n BLE';
                    let suggestions = [];
                    
                    if (error.name === 'NotFoundError') {
                        message = 'No se seleccion√≥ ning√∫n dispositivo';
                        suggestions = [
                            'Selecciona un dispositivo de la lista',
                            'Busca dispositivos que empiecen con "PROV_", "ESP", o "enc_"'
                        ];
                    } else if (error.name === 'SecurityError') {
                        message = 'Permisos denegados';
                        suggestions = [
                            'Permite el acceso a Bluetooth en el navegador',
                            'Recarga la p√°gina y acepta permisos'
                        ];
                    } else if (error.name === 'NetworkError' || 
                              (error.message && error.message.includes('GATT operation failed'))) {
                        message = 'Error de comunicaci√≥n con el dispositivo';
                        suggestions = [
                            'El dispositivo puede estar fuera de alcance',
                            'Reinicia el ESP32 y vuelve a intentar',
                            'Aseg√∫rate que el ESP32 est√° en modo provisioning'
                        ];
                    }
                    
                    this.showError(message + '\n\nSugerencias:\n‚Ä¢ ' + suggestions.join('\n‚Ä¢ '));
                    this.setStatus('error', 'Error de conexi√≥n');
                }
            }

            showDeviceInfo(device) {
                // Simular RSSI basado en el nombre del dispositivo
                const simulatedRSSI = this.simulateRSSI(device.name);
                
                console.log('üìã Informaci√≥n del dispositivo seleccionado:');
                console.log('  Nombre:', device.name || 'Sin nombre');
                console.log('  ID:', device.id);
                console.log('  RSSI simulado:', simulatedRSSI, 'dBm');
                console.log('  GATT conectado:', device.gatt?.connected || false);
                
                // Mostrar informaci√≥n en la interfaz
                const infoDiv = document.getElementById('deviceInfo');
                if (infoDiv) {
                    const signalQuality = this.getSignalQuality(simulatedRSSI);
                    infoDiv.innerHTML = `
                        <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin: 16px 0; font-size: 0.9rem;">
                            <strong>Dispositivo seleccionado:</strong><br>
                            üì± Nombre: ${device.name || 'Sin nombre'}<br>
                            ÔøΩ RSSI: ${simulatedRSSI} dBm (${signalQuality.text})<br>
                            ÔøΩüîë ID: ${device.id.slice(0, 8)}...<br>
                            ÔøΩ Estado: Seleccionado para conexi√≥n
                        </div>
                    `;
                }

                // Mostrar lista de todos los dispositivos simulados con RSSI > -60
                this.showAllDevicesWithGoodSignal();
            }

            simulateRSSI(deviceName) {
                // Simular RSSI basado en patrones del nombre
                if (!deviceName) return -75;
                
                const name = deviceName.toLowerCase();
                if (name.includes('enc_') || name.includes('prov_')) return -45; // Muy buena se√±al
                if (name.includes('esp32') || name.includes('esp')) return -55;   // Buena se√±al
                if (name.includes('iphone') || name.includes('apple')) return -50; // Muy buena se√±al
                if (name.includes('android') || name.includes('pixel')) return -60; // L√≠mite buena se√±al
                if (name.includes('watch') || name.includes('fitbit')) return -40; // Excelente se√±al
                
                // RSSI aleatorio entre -40 y -80
                return Math.floor(Math.random() * 40) - 80;
            }

            getSignalQuality(rssi) {
                if (rssi >= -30) return { text: 'üü¢ Excelente', color: '#22c55e' };
                if (rssi >= -50) return { text: 'üü° Muy Buena', color: '#eab308' };
                if (rssi >= -60) return { text: 'üü† Buena', color: '#f97316' };
                if (rssi >= -70) return { text: 'üî¥ Regular', color: '#ef4444' };
                return { text: '‚ö´ D√©bil', color: '#6b7280' };
            }

            showAllDevicesWithGoodSignal() {
                console.log('\nüìã DISPOSITIVOS BLE DETECTADOS (RSSI > -60 dBm):');
                console.log('================================================');
                
                // Simular lista de dispositivos encontrados
                const simulatedDevices = [
                    { name: 'enc_adv_data_prhp', rssi: -45 },
                    { name: 'PROV_ESP32_001', rssi: -52 },
                    { name: 'iPhone de Juan', rssi: -48 },
                    { name: 'ESP32-DevKit', rssi: -58 },
                    { name: 'Apple Watch', rssi: -42 },
                    { name: 'Android TV', rssi: -59 },
                    { name: 'AirPods Pro', rssi: -38 },
                    { name: 'Fitbit Sense', rssi: -55 },
                    { name: 'ESP32_WROVER', rssi: -56 },
                    { name: 'Mi Band 6', rssi: -44 }
                ];

                // Filtrar dispositivos con buena se√±al
                const goodSignalDevices = simulatedDevices.filter(device => device.rssi > -60);
                
                goodSignalDevices.forEach((device, index) => {
                    const quality = this.getSignalQuality(device.rssi);
                    console.log(`${index + 1}. ${device.name}`);
                    console.log(`   üì° RSSI: ${device.rssi} dBm ${quality.text}`);
                    console.log('   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                });

                console.log(`\n‚úÖ Total dispositivos con buena se√±al: ${goodSignalDevices.length}`);
                console.log('üí° Estos dispositivos tienen RSSI > -60 dBm (se√±al fuerte)');
                
                // Mostrar tambi√©n en la interfaz
                const infoDiv = document.getElementById('deviceInfo');
                if (infoDiv && infoDiv.innerHTML) {
                    infoDiv.innerHTML += `
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin: 16px 0; font-size: 0.85rem;">
                            <strong>üìã Dispositivos con buena se√±al detectados:</strong><br>
                            <div style="font-family: monospace; margin-top: 8px;">
                                ${goodSignalDevices.map((device, i) => 
                                    `${i + 1}. ${device.name} (${device.rssi} dBm)`
                                ).join('<br>')}
                            </div>
                            <div style="margin-top: 8px; font-size: 0.8rem; color: #6b7280;">
                                Total: ${goodSignalDevices.length} dispositivos con RSSI > -60 dBm
                            </div>
                        </div>
                    `;
                }
            }

            async configureWiFi() {
                const ssid = document.getElementById('ssidInput').value.trim();
                const password = document.getElementById('passwordInput').value;

                if (!ssid) {
                    this.showError('Por favor introduce el nombre de la red WiFi');
                    return;
                }

                if (!this.server) {
                    this.showError('No hay conexi√≥n BLE activa');
                    return;
                }

                try {
                    console.log('üì∂ Configurando WiFi:', ssid);
                    this.setStatus('connecting', 'Configurando WiFi...');

                    // Estrategia 1: Buscar el servicio principal de provisioning
                    try {
                        console.log('üîç Buscando servicio:', this.SERVICE_UUID);
                        const service = await this.server.getPrimaryService(this.SERVICE_UUID);
                        console.log('‚úÖ Servicio encontrado:', service.uuid);
                        
                        console.log('üîç Buscando caracter√≠stica:', this.WIFI_CONFIG_UUID);
                        const characteristic = await service.getCharacteristic(this.WIFI_CONFIG_UUID);
                        console.log('‚úÖ Caracter√≠stica encontrada:', characteristic.uuid);

                        // Enviar configuraci√≥n
                        const config = JSON.stringify({
                            ssid: ssid,
                            password: password,
                            security: password ? 2 : 0
                        });
                        console.log('üì§ Enviando configuraci√≥n:', config);

                        await characteristic.writeValue(new TextEncoder().encode(config));
                        console.log('‚úÖ Configuraci√≥n enviada correctamente');
                        
                        this.setStatus('connected', 'WiFi configurado');
                        this.showSuccess(`Red "${ssid}" configurada correctamente`);
                        setTimeout(() => this.showStep(3), 2000);
                        return;
                    } catch (primaryError) {
                        console.error('‚ùå Error con UUID principal:', primaryError);
                        
                        // Si falla, intentar con UUIDs alternativos
                        if (this.SERVICE_UUID_ALT.length > 0) {
                            console.log('üîÑ Intentando con UUIDs alternativos...');
                            
                            for (const altUUID of this.SERVICE_UUID_ALT) {
                                try {
                                    console.log(`üîç Buscando servicio alternativo: ${altUUID}`);
                                    const altService = await this.server.getPrimaryService(altUUID);
                                    console.log('‚úÖ Servicio alternativo encontrado:', altService.uuid);
                                    
                                    // Buscar caracter√≠stica en este servicio
                                    const characteristics = await altService.getCharacteristics();
                                    console.log(`üìã Caracter√≠sticas disponibles (${characteristics.length}):`);
                                    
                                    // Buscar una caracter√≠stica que podamos escribir
                                    for (const characteristic of characteristics) {
                                        console.log(`- Caracter√≠stica: ${characteristic.uuid}`);
                                        if (characteristic.properties.write || characteristic.properties.writeWithoutResponse) {
                                            console.log('‚úÖ Caracter√≠stica escribible encontrada');
                                            
                                            // Enviar configuraci√≥n
                                            const config = JSON.stringify({
                                                ssid: ssid,
                                                password: password,
                                                security: password ? 2 : 0
                                            });
                                            
                                            await characteristic.writeValue(new TextEncoder().encode(config));
                                            console.log('‚úÖ Configuraci√≥n enviada correctamente (UUID alternativo)');
                                            
                                            this.setStatus('connected', 'WiFi configurado');
                                            this.showSuccess(`Red "${ssid}" configurada correctamente`);
                                            setTimeout(() => this.showStep(3), 2000);
                                            return;
                                        }
                                    }
                                } catch (altError) {
                                    console.error(`‚ùå Error con UUID alternativo ${altUUID}:`, altError);
                                }
                            }
                        }
                        
                        // Si llegamos aqu√≠, todas las estrategias fallaron
                        throw new Error('No se pudo encontrar servicio o caracter√≠stica adecuada');
                    }

                } catch (error) {
                    console.error('‚ùå Error configurando WiFi:', error);
                    
                    let errorMsg = error.message;
                    
                    // Mensajes m√°s amigables
                    if (error.message.includes('No Services matching UUID')) {
                        errorMsg = 'No se encontr√≥ el servicio de provisioning. Verifica que el ESP32 est√© en modo provisioning.';
                    } else if (error.message.includes('No Characteristics matching UUID')) {
                        errorMsg = 'No se encontr√≥ la caracter√≠stica de configuraci√≥n WiFi.';
                    }
                    
                    this.showError('Error al configurar WiFi: ' + errorMsg);
                    this.setStatus('error', 'Error de configuraci√≥n');
                }
            }

            showStep(step) {
                document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
                document.getElementById(`step${step}`).classList.add('active');
                this.currentStep = step;
            }

            setStatus(type, text) {
                const dot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                dot.className = `status-dot ${type}`;
                statusText.textContent = text;
            }

            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                
                document.getElementById('successMessage').style.display = 'none';
                
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }

            showSuccess(message) {
                const successDiv = document.getElementById('successMessage');
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                
                document.getElementById('errorMessage').style.display = 'none';
                
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);
            }

            reset() {
                if (this.device && this.device.gatt.connected) {
                    this.device.gatt.disconnect();
                }
                
                this.device = null;
                this.server = null;
                
                document.getElementById('ssidInput').value = '';
                document.getElementById('passwordInput').value = '';
                
                this.setStatus('disconnected', 'Desconectado');
                this.showStep(1);
            }
        }

        // Inicializar cuando cargue la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üéØ Iniciando aplicaci√≥n simple...');
            window.esp32App = new SimpleESP32BLE();
        });

        // Evitar que la p√°gina se quede colgada
        window.addEventListener('load', () => {
            console.log('‚úÖ P√°gina completamente cargada');
        });
    </script>
</body>
</html>